---
title: "Simulation One"
output: html_document
---

```{r setup, include=FALSE}
renv::activate("..")
knitr::opts_chunk$set(echo = TRUE)
library(parallel); library(snow)
library(devtools)
library(tidyverse)

source("Functions/getTruth.R")
source("Functions/simulatedData.R")

load_all("../survtmle")

do.one <- function(X, n, equal = T, truth, msm.formula = "trt*w2", msm.family){
  set.seed(X)
	dat <- makeData(n = n, equal = equal)
	fit <- tryCatch({suppressWarnings(mean_tmle(ftime = dat$ftime, ftype = dat$ftype,
	                           trt = dat$trt, adjustVars = dat$adjustVars,
	                           glm.trt = "1", t0 = 6,
	                           glm.ftime = "trt*factor(w2)*w1",
	                           glm.ctime = "factor(w2)*t",
	                           msm.formula = msm.formula,
	                           msm.family = msm.family))
		}, error = function(e){ rep(NA, 2*length(truth)) })
	if(class(fit) == "survtmle"){
		est <- fit$est
		se <- sqrt(diag(fit$var))
		cil <- est - 1.96 * se
		ciu <- est + 1.96 * se
		coverage <- truth < ciu & truth > cil
		bias <- est - truth
		return(c(bias,coverage))
	}else{
		return(fit)
	}
}


summary_rslt <- function(rslt, sample_size){
                  tb1 <- rslt[1:6,] %>% 
                            t() %>% 
                            as.data.frame() %>%
                            pivot_longer(cols = everything(),
                                         names_to = "coef", 
                                         values_to = "bias") %>%
                            group_by(coef) %>%
                            summarise(MSE = mean(bias^2),
                                      E_SE = mean(SE),
                                      bias = mean(bias))
                  
                  tb2 <- rslt[7:12,] %>% 
                            t() %>% 
                            as.data.frame() %>%
                            pivot_longer(cols = everything(),
                                         names_to = "coef", 
                                         values_to = "coverage") %>%
                            group_by(coef) %>%
                            summarise(coverage = mean(coverage))
                  
                  left_join(tb1, tb2, by = "coef") %>% 
                    mutate(sample_size = sample_size)  
}
cl <- makeCluster(detectCores(), type = "SOCK")
clusterExport(cl, "do.one")
clusterExport(cl, "makeData")
clusterExport(cl, "total_hazard")
clusterEvalQ(cl, devtools::load_all("../survtmle"))
```




```{r run-the-simulation, cache = TRUE}

msm.formula <-  "ftype*trt + trt*w1"
msm.family <- "poisson"
truth <- suppressWarnings(getTruth(msm.formula = msm.formula, msm.family = poisson()))
rep = 1000
### results for size 1000
size = 1000

rslt_1000 <- parSapplyLB(cl = cl, X = seq_len(rep),
                         FUN = do.one,
                         n = size,
                         truth = truth, msm.formula = msm.formula,
                         msm.family = msm.family)
saveRDS(rslt_1000, file = "size1000/re_n1000.rds")

### results for size 2000
size = 2000

rslt_2000 <- parSapplyLB(cl = cl, X = seq_len(rep),
                         FUN = do.one,
                         n = size,
                         truth = truth, msm.formula = msm.formula,
                         msm.family = msm.family)
saveRDS(rslt_2000, file = "size2000/re_n2000.rds")

### results for size 5000
size = 5000

rslt_5000 <- parSapplyLB(cl = cl, X = seq_len(rep),
                         FUN = do.one,
                         n = size,
                         truth = truth, msm.formula = msm.formula,
                         msm.family = msm.family)
saveRDS(rslt_5000, file = "size5000/re_n5000.rds")
```

## Summary Table


```{r summarize-the-results}
rslt_1000 <- readRDS("size1000/re_n1000.rds")
rslt_2000 <- readRDS("size2000/re_n2000.rds")
rslt_5000 <- readRDS("size5000/re_n5000.rds")


summary_rslt(rslt_1000, 1000)

summary_rslt(rslt_2000, 2000)

summary_rslt(rslt_5000, 5000)


```

